from pathlib import Path import runpy import sys def test_hash_attachments_ok(sandbox_repo, tmp_path): script = sandbox_repo / "tools" / "hash_attachments.py" assert script.exists() out = tmp_path / "attachments.txt" argv = sys.argv sys.argv = ["hash_attachments.py", "--root", str(sandbox_repo), "--glob", "canonized/**/*.md", "--format", "text", "--report", str(out), "--strict"] try: runpy.run_path(str(script), run_name="__main__") finally: sys.argv = argv txt = out.read_text(encoding="utf-8") assert "MISMATCH" not in txt assert "MISSING" not in txt assert "OK" in txt